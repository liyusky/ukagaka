<!DOCTYPE html>
<html style="height:100%;">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="./css/map.css">
  <link rel="stylesheet" href="./css/animate.css">
  <link rel="stylesheet" href="./css/components.css">
  <script src="./scripts/echarts.min.js"></script>
  <script src="./scripts/china.js"></script>
  <script src="./scripts/geography.js"></script>
  <script src="./scripts/points.js"></script>
  <script src="./scripts/provices.js"></script>
  <script src="./scripts/customers.js"></script>
  <script src="./scripts/customer-index.js"></script>
  <script src="./scripts/jquery-3.3.1.min.js"></script>
  <script src="./scripts/ChinaMap.class.js"></script>
</head>

<body>
  <section class="volume">
    <ul>
      <li class="trade" id="box1">
        <div class="box1"></div>
      </li>
      <li class="trade">
        <p class="trade-msg">今日交易额(元)</p>
      </li>
      <li class="trade" id="box2">
        <div class="box2"></div>
      </li>
      <li class="trade">
        <p class="trade-msg mar21">累计交易额(元)</p>
      </li>
      <li class="trade mt37" id="box3">
        <p class="trade-msg mar21 fz24">平均每笔交易(元):</p>
        <div class="box3"></div>
      </li>
      <div class="clear"></div>
      <li class="trade" id="box4">
        <p class="trade-msg fz24">近1分钟注册用户(人):</p>
        <div class="box4"></div>
      </li>
      <li class="trade" id="box5">
        <p class="trade-msg fz24">近1分钟交易笔数(数):</p>
        <div class="box5"></div>
      </li>
    </ul>
  </section>
  <section class="tradecount">
    <ul>
      <li id="box6">
        <div class="box6"></div>
      </li>
      <li>
        <p class="trade-msg">今日交易笔数(笔)</p>
      </li>
      <li id="box7">
        <div class="box7"></div>
      </li>
      <li>
        <div class="trade-msg">累计交易笔数(笔)</div>
      </li>
    </ul>
  </section>
  <section class="register-count">
    <ul>
      <li id="box8">
        <div class="box8"></div>
      </li>
      <li>
        <p class="register-msg">今日注册用户(人)</p>
      </li>
      <li id="box9">
        <div class="box9"></div>
      </li>
      <li class="register-msg">累计交易用户数(人)</li>
    </ul>
  </section>
  <section id="userProvince">
  </section>
  <section class="recently">
    <table class="newTransaction" id="newTransaction">
      <thead>
        <th>城市</th>
        <th>姓名</th>
        <th>交易金额(元)</th>
        <th>时间</th>
      </thead>
    </table>
  </section>
  <section id="userProvince">
    <div class="province-head">
      <p>今日交易用户省份TOP10</p>
      <img src="./img/arrow.png" alt="">
    </div>
    <div class="province-content">
      <ul id="province">
        <li>
      </ul>
    </div>
  </section>
  <section class="china-map">
    <div class="map" id="map"></div>
    <div class="tips" id="tips"></div>
  </section>
  <script>
    var chinaMap = new ChinaMap();
    const ws = new WebSocket("ws://192.168.0.101:8080");
    $(function () {
      var lastnum = "",
        lastarr = "";
      var fontEvent = {
        // 例 510,085.00
        number: function (digit) {
          var num_arr = [];
          for (var i = 0; i < digit.length; i++) {
            // 每一个装到数组里
            num_arr.push(digit.charAt(i));
          }
          return num_arr;
        },
        dom: function (arr) {
          var str = '';
          for (var i = 0; i < arr.length; i++) {
            // 数字
            if (parseInt(arr[i]) >= 0) {
              str += '<div class="l js-l-box digit-container boxs" data-show=' + arr[i] + '>' +
                '<span>0</span>' +
                '<span>1</span>' +
                '<span>2</span>' +
                '<span>3</span>' +
                '<span>4</span>' +
                '<span>5</span>' +
                '<span>6</span>' +
                '<span>7</span>' +
                '<span>8</span>' +
                '<span>9</span>' +
                '</div>';
            } else {
              // 标点符号
              str += '<div class="sign-box l"><span>' + arr[i] + '</span></div>';
            }
          }
          return str;
        },
        animation: function () {
          var height = $("#box1").height();
          $(".js-l-box").each(function (i) {
            // 取到每一个字符
            var num = parseInt($(this).data("show"));
            var scrollTop = 0;
            // 移动高度乘以字符
            var scrollTop = height * num;
            $(this).css("margin-top", 0);
            $(this).animate({
              marginTop: -scrollTop
            }, 1500);
          });
        }
      };

      var arr = [];

      function moveFont(fontEvent, data) {

        var final_arr = fontEvent.number(String(data.TradingVolume).getAns()); // 今日交易额
        $(".box1").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.TotalAmount).getAns()); // 累计交易额
        $(".box2").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.AvgAmount).getAns()); // 平均每笔交易
        $(".box3").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.RegUserMin1).getAns()); // 近1分钟注册用户
        $(".box4").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.TradesMin1).getAns()); // 近1分钟交易笔数
        $(".box5").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.NumberTrades).getAns()); // 今日交易笔数
        $(".box6").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.TotalTrades).getAns()); // 累计交易笔数
        $(".box7").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.TodayRegUser).getAns()); // 今日注册用户
        $(".box8").html(fontEvent.dom(final_arr));
        var final_arr = fontEvent.number(String(data.TotalRegCount).getAns()); // 累计交易用户
        $(".box9").html(fontEvent.dom(final_arr));
        fontEvent.animation();
      }


      String.prototype.getAns = function () {
        var pattern = /(?=((?!\b)\d{3})+$)/g;
        return this.replace(pattern, ',');
      };

      function cityMove(data) {
        var cityList = data.Users;
        var str = '<tbody class="tbody">' +
          '<tr>' +
          '<td>' + cityList[0].ProviceName + '</td>' +
          '<td>' + cityList[0].Name + '</td>' +
          '<td>' + cityList[0].Amount + '</td>' +
          '<td>' + cityList[0].Time + '</td>' +
          '</tr>' +
          '<tr>' +
          '<td>' + cityList[1].ProviceName + '</td>' +
          '<td>' + cityList[1].Name + '</td>' +
          '<td>' + cityList[1].Amount + '</td>' +
          '<td>' + cityList[1].Time + '</td>' +
          '</tr>' +
          '</tbody>';
        $('#newTransaction').append(str);

        setTimeout(function () {
          $('.tbody')[0].style.top = '166px';
          if ($('.tbody')[1]) $('.tbody')[1].style.top = '28px';
          setTimeout(function () {
            $('.tbody')[0].remove();
          }, 5000);
        }, 10000);
      };

      function rankings(data) {
        var html = '';
        var strimg = '';
        for (var i = 0; i < data.Provinces.length; i++) {
          if (i < 3) {
            strimg = '<img src="img/' + (i + 1) + '.png">'
          } else {
            strimg = '<span class="rank">' + (i + 1) + '</span>'
          };
          html += '<li>' +
            strimg +
            '<div class="box">' +
            '<span class="province">' + data.Provinces[i].ProviceName + '</span>' +
            '<div class="process"></div>' +
            '<span class="ratio">' + data.Provinces[i].Proportion * 100 + '%</span>' +
            '</div>' +
            '</li>';
        };
        $('#province').html(html);
        for (var j = 0; j < data.Provinces.length; j++) {
          $('.process').animate({ // 进度条总长320 10分之一为32
            width: (data.Provinces[j].Proportion * 10 * 32)
          })
        }
      };
      ws.addEventListener('message', (evt) => {
        var data = JSON.parse(decodeURIComponent(evt.data));
        arr = data;
        moveFont(fontEvent, data);
        cityMove(data);
        rankings(data);
      });
    });
    ws.onmessage = function (message) {
      chinaMap.mount(message);
    }
  </script>
</body>

</html>